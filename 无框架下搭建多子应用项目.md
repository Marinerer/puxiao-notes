# 无框架下搭建多子应用项目

**在不使用微前端框架，例如 乾坤或无界 的情况下如何搭建多应用项目。**

现在有 3 个完全独立开发、构建的子应用：aa、bb、cc

<br>

**假定现在的需求是：**

- 将 3 个子应用合并成一个总项目

  - aa 项目访问地址：http://xx.com/aa

  - bb 项目访问地址：http://xx.com/bb

  - cc 项目访问地址：http://xx.com/cc

- 每个子应用共用同一个登录页(多角色)

  - RoleA：总管理员

  - RoleB：xx角色

  - RoleC：xx角色

- 每个子应用需要适配不同角色的访问权限

  - aa项目：允许所有角色访问

  - bb项目：仅允许RoleB角色访问

  - cc项目：仅允许RoleC角色访问

<br>

**问题与解决方案：各个页面 URL 如何配置？**

假定 bb 项目有一个页面 URL 为：http://xx.com/bb/list/detail

那么上面 URL 实际分为 2 部分：

- `http://xx.com/bb/`：这个是打包后存放在 web 服务根下的目录位置

- `/list/detail`：这个是 bb 项目中由 vue-router 配置的页面路由

我们需要做的事情是：

- 在 bb 项目 vite.config.ts 中增加 base: '/bb'

  > 注意上面是 '/bb' 而不是 '/bb/'

- 在 nginx.config 中增加对 `/bb/` 路由的拦截处理

  ```
  location /bb/ {
      try_files $uri $uri/ /bb/index.html;
  }
  ```

对于 nginx 而言：`http://xx.com/bb/list/detail` 不再认定为 404。

对于 bb 子项目而言：

- `http://xx.com/bb`、`http://xx.com/bb/`、`http://xx.com/bb/xx...` 这些 URL 都可以正确被 bb 子项目中的路由命中。

- 对于非 `/bb` 的 URL，例如 `http://xx.com/cc` 因为 nginx 的拦截不会被 bb 路由命中。

  > 但 bb 项目的 dev 调试阶段 `http://localhost/cc` 是会被 bb 路由命中的。

<br>

以此类推去配置 aa、cc 子应用。

<br>

**问题与解决方案：如何统一登录？**

很简单，就是把登录当成一个独立的子项目单独做一下，最终部署。

和开发其他子应用类似，也需要对应去配置项目本身路由和 nginx。

假设我们命名为 auth，最终部署后：

- 登录页：`http://xx.com/auth/login`

- 注册页：`http://xx.com/auth/register`

- ...

当登录成功后：把 token 写入到 localStorage 中

退出登录：清除 localStorage 中的 token

由于各个子项目和登录都在同一个域名下，所以各个子模块都可以从 localStorage 中读取到 token。

<br>

**问题与解决方案：各子项目如何适配不同角色的访问权限？**

各个子项目项目初始化时，立即尝试从 localStorage 读取 token 并请求 API 去验证获取当前 用户角色信息，然后再根据自己配置的角色访问权限来决定是否是正常渲染还是跳转至 403 无权限页面。

若读取不到 token 则跳转至登录页。

**注意这里说的子项目与登录页跳转都是指通过 `window.location.href = xx` 方式跳转，而不是靠子项目内部的路由跳转。**



<br>

**问题与解决方案：如何处理整个项目的首页？**

上面已经讲解了各子页面和登录模块的目录 URL 配置，那么对于首页，也就是 `http://xx.com/` 这个首页该如何配置？

通常有几种选择：

1. 把某个子应用直接构建到根目录，例如直接将 aa 项目作为首页
2. 或者直接通过 nginx 配置将首页通过 304 跳转至 `http://xx.com/xx/index.html` 某个页面
3. 新建一个 index.html 放到根目录，作为项目默认首页，index.html 可以显示为各个子应用连接入口
4. ...

无论哪种选择，关于 `/` 的 nginx 配置：

```
location = / {
    # 304 跳转
    # return 301 /aa/;

    # 明确首页为根目录下的 index.html
    index index.html;
}
```

**请注意：一定要写成 `location = / {`，绝不可以写成 `location / {`** 

> `location / {` 会将所有包含 `/` 的 URL 都命中成首页。



<br>

**关于 nginx 的一些其他可选配置：**

```
# 禁止访问隐藏文件(以 . 开头的文件)
location ~ /\. {
    deny all;
    access_log off;
    log_not_found off;
}

# 禁止所有 index.html 缓存
location ~ /index\.html$ {
    add_header Cache-Control "no-store, no-cache, must-revalidate";
    add_header Pragma "no-cache";
    expires -1;
}

# 静态资源长缓存
location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
    expires 30d;
    add_header Cache-Control "public, no-transform";
}
```



<br>

**最后总结：**

1. 前端子应用 aa 的 vite 配置 `.base` 为 `aa` ，路由根目录为 `http://xx.com/aa`
2. 通过 nginx 配置对应的 `try_files`，可以拦截 `http://xx.com/aa/zz` 中 `/aa/zz` 这样的 URL 转给子应用的路由处理
3. 由于所有子应用都在同一个域名下，可以共享 localStorage 等，实现各子应用共享一个登录 token

最终实现无框架下搭建多子应用项目。

