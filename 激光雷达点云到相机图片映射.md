# 激光雷达点云到相机图片映射



**本文为我个人实际点云标注工具开发遇到的一些经验总结，如何实现：将点云场景中标注的立方体映射到相机图片上**

本文所说的：

* "点云场景" ：是指在浏览器中使用 three.js 加载 自动驾驶中激光雷达得到的 .pcd 文件并渲染出来的 3D 空间
* "相机图片" ：是指车载相机所拍摄的照片
* "映射"：是指 3D 点云场景中绘制的立方体对应在相机中的对应的映射结果，即伪立方体或框



<br>

我们需要先学习几个知识点：

* 点云的坐标系与three.js坐标系的差异
* 相机的内参和外参





<br>

## 点云的坐标系与three.js坐标系的差异



<br>

**原始点云与three.js坐标系的不同：**

* three.js 中采用右手坐标系，在我们的相机默认视角中
  * 屏幕右侧为 X 轴正方向
  * 屏幕向上为 Y 轴正方向
  * 屏幕指向我们眼睛的为 Z 轴正方向 

* 自动驾驶的点云坐标系，通常为
  * 汽车车头方向为 X 轴正方向
  * 汽车车顶方向为 Y 轴正方向
  * 汽车左侧方向为 Z 轴正方向

由于点云与 three.js 空间坐标轴方向不同，所以如果默认加载进来的点云通常是 "头朝下" 显示的。



<br>

**坐标系之间的变换矩阵：**

如果你不介意点云方向不正确那也无所谓，可以跳过本小节。

如果你希望能够能够将点云矫正过来，那么你需得到这 2 个坐标系(原始点云与three.js)之间的转换矩阵。

假定在 three.js 的空间中，我们将点云进行下面的旋转操作就可以将点云 "方向纠正"：

* 将原始点云 X 轴旋转 -90度
* Y 轴保持不变
* Z 轴旋转 180度

<br>

> 上面提到的旋转角度 正或负，遵循的是右手螺旋法则



<br>

注意上面旋转角度仅仅是我们举例，实际点云旋转能否纠正还要看具体情况。

同时 three.js 使用的是弧度而不是度，不管如何，我们假定当前的旋转为：

* x 轴旋转 xrn (弧度) //该值可以是 0
* y 轴旋转 yrn (弧度) //该值可以是 0
* z 轴旋转 zrn (弧度) //该值可以是 0

有了上面 3 个值，就可以计算出对应的旋转矩阵 rotationMatrix：

```
import { Euler, Matrix4 } from "three"

const rotationMatrix = new Matrix4().makeRotationFromEuler(new Euler(xrn, yrn, zrn))
```



<br>

实际中还有可能需要进行 "点云平移"。

假定：

* x 轴平移 xtn (米) //该值可以是 0
* y 轴平移 ytn (米) //该值可以是 0
* z 轴平移 ztn (米)  //该值可以是 0

有了上面 3 个值，我们就可以计算出对应的平移矩阵 offsetMatrix：

```
const offsetMatrix = new Matrix4().makeTranslation(xtn, ytn, ztn)
```



<br>

那我们此时有了 平移矩阵 和 旋转矩阵，就可以得出 点云 在 three.js 中进行的变换矩阵 pcdMatrix：

```
const pcdMatrix = offsetMatrix.clone().multiply(rotationMatrix)
```

> 注：我们使用了 平移矩阵乘以旋转矩阵，意味着其结果是：先执行旋转，然后再平移

知道了 pcdMatrix 自然就可以知道它的逆矩阵 pcdMatrixInvert：

```
const pcdMatrixInvert = pcdMatrix.clone().invert()
```



<br>

只此，我们知道了 点云在 three.js 中的变换矩阵 pcdMatrix 和它的逆矩阵 pcdMatrixInvert。



<br>

**执行"点云矫正"：**

为了改变点云显示结果，对其 "矫正"，我们只需在 PCDLoader 加载点云完成事件中操作一下：

```
import { PCDLoader } from 'three/examples/jsm/loaders'

const pcdLoader = new PCDLoader()
pcdLoader.load('xxx.pcd', (points) =>{
    points.geometry.applyMatrix4(pcdMatrix)
    
    ...
    
    editor.scene.add(points)
})
```

这样点云的方向就被我们 "矫正" 过来了。



<br>

再次重申：本小节所讲 "点云矫正"，仅仅实际项目中可能发生的，但不是必须的，你完全可以忽略，跳过本小节。



<br>

## 相机的内参和外参

未完待续...